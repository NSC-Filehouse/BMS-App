import React from 'react';

const STORAGE_KEY = 'bms.lang';

export function getStoredLanguage() {
  try {
    return localStorage.getItem(STORAGE_KEY) || 'de';
  } catch {
    return 'de';
  }
}

const translations = {
  de: {
    app_title: 'BMS-App',
    start_title: 'Mandant auswählen',
    start_prompt: 'Bitte wähle den Mandanten, mit dem du arbeiten möchtest.',
    start_user: 'Benutzer',
    start_email: 'E-Mail',
    start_no_permission_title: 'Keine Berechtigung',
    start_no_permission_text: 'Sie sind nicht berechtigt diese Funktionen zu nutzen.',
    start_continue: 'Weiter',
    start_reload: 'Neu laden',
    mandant_label: 'Mandant',
    mandant_none: 'Kein Mandant gewählt',
    switch_mandant: 'Mandant wechseln',
    customers_title: 'Kunden',
    customers_search: 'Kunden durchsuchen',
    customers_empty: 'Keine Kunden',
    products_title: 'Produkte',
    products_search: 'Produkte durchsuchen',
    products_empty: 'Es gibt keine Produkte',
    products_loading_items: 'Lädt...',
    orders_title: 'Reservierungen',
    orders_search: 'Reservierungen durchsuchen',
    orders_empty: 'Keine aktiven Reservierungen',
    page_label: 'Seite',
    desc_label: 'Beschreibung',
    address_label: 'Adresse',
    state_label: 'Bundesland',
    sales_rep_section: 'Außendienstler',
    sales_rep_label: 'Außendienst',
    contact_label: 'Ansprechpartner',
    phone_label: 'Telefon',
    email_label: 'E-Mail',
    back_label: 'Zurück',
    loading_error: 'Fehler beim Laden.',
    loading_mandants_error: 'Fehler beim Laden der Mandanten.',
    loading_categories_error: 'Fehler beim Laden der Kategorien.',
    loading_products_error: 'Fehler beim Laden.',
    loading_orders_error: 'Fehler beim Laden.',
    order_customer: 'Kunde',
    order_distributor: 'Mandant',
    order_article: 'Produkte',
    order_price: 'Gesamtpreis',
    order_closing: 'Bestellschluss',
    order_reserved_until: 'Reserviert bis',
    order_created: 'Datum der Reservierungserstellung',
    order_owner: 'Verantwortlicher Aussendienstmitarbeiter',
    order_passed_to: 'Weitergereicht an',
    order_received_from: 'Empfangen von',
    order_completed: 'Abgeschlossen',
    order_confirmed: 'Bestätigt',
    product_price: 'Einstandspreis',
    product_add_to_order: 'Zu Reservierung hinzufügen',
    product_be_number: 'BE Nummer',
    product_reserved: 'Bereits reserviert',
    product_category: 'Kunststoff Kategorie',
    product_amount: 'Menge',
    product_unit: 'Einheit',
    product_article: 'Produkte',
    product_warehouse: 'Lager',
    product_extra: 'Zusatztext',
    product_supplier: 'Lieferant',
    product_description: 'Beschreibung',
    product_mfi: 'MFI',
    product_reserved_by: 'Reserviert von',
    product_reserved_until: 'Reserviert bis',
    product_mfi_method: 'MFI Prüfmethode',
    product_warehouse_section: 'Lagerbereich',
    product_storage_id: 'Lager-ID',
    product_group_empty: 'Ohne Kategorie',
    product_subgroup_empty: 'Ohne Untergruppe',
    product_reserve_amount: 'Reservierung (kg)',
    product_reserve_until: 'Datum von bis reserviert',
    product_reserve_comment: 'Kommentar',
    product_reserve_submit: 'Reservierung',
    product_reserve_confirmed: 'Reservierung erstellt',
    product_available_now: 'Verfügbar',
    product_reserve_too_much: 'Reservierung darf die verfügbare Menge nicht überschreiten',
    order_reserve_amount: 'Reservierung',
    order_comment: 'Kommentar',
    product_already_reserved: 'F\u00FCr dieses Produkt liegt bereits eine Reservierung vor.',
    product_already_reserved_by: 'F\u00FCr dieses Produkt liegt bereits eine Reservierung durch {by} vor.',
    product_create_order: 'Auftrag erstellen',
    reservation_edit: 'Reservierung ändern',
    reservation_delete: 'Reservierung löschen',
    reservation_create_title: 'Reservierung erstellen',
    order_add: 'Reservierung hinzufügen',
    reservation_updated: 'Reservierung aktualisiert',
    reservation_deleted: 'Reservierung gelöscht',
    temp_orders_title: 'Aufträge',
    temp_orders_search: 'Aufträge durchsuchen',
    temp_orders_empty: 'Keine Aufträge',
    temp_order_create_title: 'Auftrag erstellen',
    temp_order_edit_title: 'Auftrag ändern',
    temp_order_saved: 'Auftrag gespeichert',
    temp_order_deleted: 'Auftrag gelöscht',
    temp_order_add: 'Auftrag hinzufügen',
    customer_select: 'Kunde wählen',
    product_select: 'Produkt wählen',
    supplier_select: 'Lieferant wählen',
    delivery_type_label: 'Liefertyp',
    packaging_type_label: 'Verpackungsart',
    delivery_start: 'Lieferstart',
    delivery_end: 'Lieferende',
    special_payment_condition: 'Abweichende Zahlungsbedingung',
    save_label: 'Speichern',
    delete_label: 'Löschen',
    edit_label: 'Ändern',
    yes_label: 'Ja',
    no_label: 'Nein',
    validation_dialog_title: 'Bitte Eingaben prüfen',
    validation_customer_required: 'Bitte einen Kunden auswählen.',
    validation_product_required: 'Bitte ein Produkt auswählen.',
    validation_customer_name_required: 'Kundenname darf nicht leer sein.',
    validation_customer_address_required: 'Kundenadresse darf nicht leer sein.',
    validation_supplier_required: 'Bitte einen Lieferanten auswählen.',
    validation_amount_positive: 'Menge muss größer als 0 sein.',
    validation_price_positive: 'Preis muss größer als 0 sein.',
    validation_reservation_positive: 'Reservierungsmenge muss größer als 0 sein.',
    validation_reservation_not_above_amount: 'Reservierungsmenge darf nicht größer als die Gesamtmenge sein.',
    validation_reservation_date_required: 'Bitte ein Reservierungsdatum angeben.',
    validation_delivery_dates_required: 'Bitte Lieferstart und Lieferende angeben.',
    validation_delivery_range_invalid: 'Lieferstart darf nicht nach Lieferende liegen.',
  },
  en: {
    app_title: 'BMS App',
    start_title: 'Select Mandant',
    start_prompt: 'Please choose the mandant you want to work with.',
    start_user: 'User',
    start_email: 'Email',
    start_no_permission_title: 'No Permission',
    start_no_permission_text: 'You are not authorized to use these features.',
    start_continue: 'Continue',
    start_reload: 'Reload',
    mandant_label: 'Mandant',
    mandant_none: 'No mandant selected',
    switch_mandant: 'Switch mandant',
    customers_title: 'Customers',
    customers_search: 'Search customers',
    customers_empty: 'No customers',
    products_title: 'Products',
    products_search: 'Search products',
    products_empty: 'No products',
    products_loading_items: 'Loading...',
    orders_title: 'Orders',
    orders_search: 'Search orders',
    orders_empty: 'No active orders',
    page_label: 'Page',
    desc_label: 'Description',
    address_label: 'Address',
    state_label: 'State',
    sales_rep_section: 'Sales Representative',
    sales_rep_label: 'Sales Rep',
    contact_label: 'Contact',
    phone_label: 'Phone',
    email_label: 'Email',
    back_label: 'Back',
    loading_error: 'Failed to load.',
    loading_mandants_error: 'Failed to load mandants.',
    loading_categories_error: 'Failed to load categories.',
    loading_products_error: 'Failed to load.',
    loading_orders_error: 'Failed to load.',
    order_customer: 'Customer',
    order_distributor: 'Mandant',
    order_article: 'Article',
    order_price: 'Total price',
    order_closing: 'Order closing',
    order_reserved_until: 'Reserved until',
    order_created: 'Order created',
    order_owner: 'Responsible sales rep',
    order_passed_to: 'Passed to',
    order_received_from: 'Received from',
    order_completed: 'Completed',
    order_confirmed: 'Confirmed',
    product_price: 'Cost price',
    product_add_to_order: 'Add to order',
    product_be_number: 'BE number',
    product_reserved: 'Reserved',
    product_category: 'Plastic category',
    product_amount: 'Amount',
    product_unit: 'Unit',
    product_article: 'Article',
    product_warehouse: 'Warehouse',
    product_extra: 'Extra text',
    product_supplier: 'Supplier',
    product_description: 'Description',
    product_mfi: 'MFI',
    product_reserved_by: 'Reserved by',
    product_reserved_until: 'Reserved until',
    product_mfi_method: 'MFI test method',
    product_warehouse_section: 'Warehouse section',
    product_storage_id: 'Storage ID',
    product_group_empty: 'No category',
    product_subgroup_empty: 'No subgroup',
    product_reserve_amount: 'Reservation (kg)',
    product_reserve_until: 'Reserved until',
    product_reserve_comment: 'Comment',
    product_reserve_submit: 'Reserve',
    product_reserve_confirmed: 'Reservation created',
    product_available_now: 'Available',
    product_reserve_too_much: 'Reservation amount must not exceed available quantity',
    order_reserve_amount: 'Reservation',
    order_comment: 'Comment',
    product_already_reserved: 'A reservation for this product already exists.',
    product_already_reserved_by: 'A reservation for this product already exists by {by}.',
    product_create_order: 'Create order',
    reservation_edit: 'Edit reservation',
    reservation_delete: 'Delete reservation',
    reservation_create_title: 'Create reservation',
    order_add: 'Add reservation',
    reservation_updated: 'Reservation updated',
    reservation_deleted: 'Reservation deleted',
    temp_orders_title: 'Orders',
    temp_orders_search: 'Search orders',
    temp_orders_empty: 'No orders',
    temp_order_create_title: 'Create order',
    temp_order_edit_title: 'Edit order',
    temp_order_saved: 'Order saved',
    temp_order_deleted: 'Order deleted',
    temp_order_add: 'Add order',
    customer_select: 'Select customer',
    product_select: 'Select product',
    supplier_select: 'Select supplier',
    delivery_type_label: 'Delivery type',
    packaging_type_label: 'Packaging type',
    delivery_start: 'Delivery start',
    delivery_end: 'Delivery end',
    special_payment_condition: 'Special payment condition',
    save_label: 'Save',
    delete_label: 'Delete',
    edit_label: 'Edit',
    yes_label: 'Yes',
    no_label: 'No',
    validation_dialog_title: 'Please check your inputs',
    validation_customer_required: 'Please select a customer.',
    validation_product_required: 'Please select a product.',
    validation_customer_name_required: 'Customer name must not be empty.',
    validation_customer_address_required: 'Customer address must not be empty.',
    validation_supplier_required: 'Please select a supplier.',
    validation_amount_positive: 'Amount must be greater than 0.',
    validation_price_positive: 'Price must be greater than 0.',
    validation_reservation_positive: 'Reservation amount must be greater than 0.',
    validation_reservation_not_above_amount: 'Reservation amount must not be greater than total amount.',
    validation_reservation_date_required: 'Please provide a reservation date.',
    validation_delivery_dates_required: 'Please provide delivery start and delivery end.',
    validation_delivery_range_invalid: 'Delivery start must not be after delivery end.',
  },
};

function getInitialLang() {
  return getStoredLanguage();
}

const I18nContext = React.createContext({
  lang: 'de',
  setLang: () => {},
  t: (key) => key,
});

export function LanguageProvider({ children }) {
  const [lang, setLangState] = React.useState(getInitialLang());

  const setLang = React.useCallback((value) => {
    const next = value === 'en' ? 'en' : 'de';
    setLangState(next);
    try {
      localStorage.setItem(STORAGE_KEY, next);
    } catch {
      // ignore
    }
  }, []);

  const t = React.useCallback((key, vars = null) => {
    const dict = translations[lang] || translations.de;
    const text = dict[key] || translations.de[key] || key;
    if (!vars || typeof text !== 'string') return text;
    return Object.keys(vars).reduce(
      (acc, name) => acc.replace(new RegExp(`\\{${name}\\}`, 'g'), String(vars[name] ?? '')),
      text
    );
  }, [lang]);

  const value = React.useMemo(() => ({ lang, setLang, t }), [lang, setLang, t]);

  return (
    <I18nContext.Provider value={value}>
      {children}
    </I18nContext.Provider>
  );
}

export function useI18n() {
  return React.useContext(I18nContext);
}
